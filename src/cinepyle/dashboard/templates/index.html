<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cinepyle Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      line-height: 1.6;
      padding: 2rem;
      max-width: 700px;
      margin: 0 auto;
    }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; color: #fff; }
    h2 {
      font-size: 1.1rem; margin: 1.5rem 0 0.75rem; color: #ccc;
      border-bottom: 1px solid #333; padding-bottom: 0.4rem;
    }
    label { display: block; margin: 0.4rem 0; cursor: pointer; }
    input[type="text"], input[type="password"], input[type="number"],
    textarea, select {
      width: 100%; padding: 0.5rem 0.7rem; background: #1a1a1a;
      border: 1px solid #333; border-radius: 6px; color: #e0e0e0; font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    input[type="number"] { width: 80px; }
    textarea { min-height: 80px; resize: vertical; }
    select { width: auto; min-width: 100px; }
    .row { display: flex; gap: 1rem; align-items: center; margin: 0.5rem 0; }
    button {
      padding: 0.6rem 1.4rem; border: none; border-radius: 6px;
      font-size: 0.9rem; cursor: pointer; margin-top: 0.5rem;
    }
    button.primary { background: #2563eb; color: #fff; }
    button.primary:hover { background: #1d4ed8; }
    button.secondary { background: #333; color: #e0e0e0; }
    button.secondary:hover { background: #444; }
    .alert { padding: 0.6rem 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
    .alert-success { background: #14532d; color: #86efac; }
    .alert-info { background: #1e3a5f; color: #93c5fd; }
    .hint { font-size: 0.8rem; color: #888; margin-top: 0.2rem; }
    .actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 1.5rem; }
    .tab {
      flex: 1; padding: 0.7rem; border: 1px solid #333;
      background: #1a1a1a; color: #888; cursor: pointer;
      font-size: 0.9rem; border-bottom: 2px solid transparent;
    }
    .tab:first-child { border-radius: 6px 0 0 6px; }
    .tab:last-child { border-radius: 0 6px 6px 0; }
    .tab.active { background: #222; color: #fff; border-bottom-color: #2563eb; }

    /* Screen alert styles */
    details.chain-group { margin: 0.5rem 0; }
    details.chain-group > summary {
      cursor: pointer; font-weight: 600; font-size: 1rem;
      color: #ccc; padding: 0.4rem 0;
    }
    details.theater-group { margin: 0.3rem 0; padding-left: 1rem; }
    details.theater-group > summary {
      cursor: pointer; font-weight: 500; font-size: 0.9rem;
      color: #aaa; padding: 0.2rem 0;
    }
    .theater-addr { font-size: 0.75rem; color: #666; margin-left: 0.5rem; }
    .screen-label {
      display: block; margin: 0.15rem 0; padding-left: 2rem; font-size: 0.85rem;
    }
    .screen-label.special { color: #93c5fd; }
    .badge {
      font-size: 0.65rem; background: #2563eb33; color: #93c5fd;
      padding: 0.05rem 0.4rem; border-radius: 3px; margin-left: 0.3rem;
      text-transform: uppercase;
    }
    .seats { font-size: 0.7rem; color: #666; margin-left: 0.3rem; }
    .no-data { font-size: 0.85rem; color: #666; padding: 1rem 0; }
  </style>
</head>
<body>
  <h1>ğŸ¬ Cinepyle Dashboard</h1>

  <!-- Tab Navigation -->
  <nav class="tabs">
    <button type="button" class="tab {% if active_tab != 'screens' %}active{% endif %}"
      onclick="switchTab('digest')">ğŸ“° ë‹¤ì´ì œìŠ¤íŠ¸</button>
    <button type="button" class="tab {% if active_tab == 'screens' %}active{% endif %}"
      onclick="switchTab('screens')">ğŸ¥ ìƒì˜ê´€ ì•Œë¦¼</button>
  </nav>

  <!-- ============================================================ -->
  <!-- Tab: Digest -->
  <!-- ============================================================ -->
  <div id="tab-digest" style="{% if active_tab == 'screens' %}display:none{% endif %}">

    {% if saved %}
    <div class="alert alert-success">ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    {% endif %}
    {% if test_sent %}
    <div class="alert alert-info">í…ŒìŠ¤íŠ¸ ë‹¤ì´ì œìŠ¤íŠ¸ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤. í…”ë ˆê·¸ë¨ì„ í™•ì¸í•˜ì„¸ìš”.</div>
    {% endif %}

    <form method="post" action="/settings">
      <h2>ğŸ“¡ ë‰´ìŠ¤ ì†ŒìŠ¤</h2>
      <label>
        <input type="checkbox" name="google_enabled" value="true"
          {{ "checked" if settings.sources_enabled.get("google", True) }}>
        Google ì˜í™”ë‰´ìŠ¤
      </label>
      <label>
        <input type="checkbox" name="cine21_enabled" value="true"
          {{ "checked" if settings.sources_enabled.get("cine21", True) }}>
        Cine21
      </label>
      <label>
        <input type="checkbox" name="watcha_enabled" value="true"
          {{ "checked" if settings.sources_enabled.get("watcha", True) }}>
        Watcha ë§¤ê±°ì§„
      </label>

      <h2>â° ìŠ¤ì¼€ì¤„</h2>
      <label>
        <input type="checkbox" name="schedule_enabled" value="true"
          {{ "checked" if settings.schedule_enabled }}>
        ë‹¤ì´ì œìŠ¤íŠ¸ í™œì„±í™”
      </label>
      <div class="row">
        <label>
          ì‹œê°„ (KST)
          <input type="number" name="schedule_hour" min="0" max="23"
            value="{{ settings.schedule_hour }}">
        </label>
        <label>
          ë¶„
          <input type="number" name="schedule_minute" min="0" max="59"
            value="{{ settings.schedule_minute }}">
        </label>
      </div>

      <h2>ğŸ¤– AI ì„¤ì •</h2>
      <label>
        LLM Provider
        <select name="llm_provider">
          <option value="openai" {{ "selected" if settings.llm_provider == "openai" }}>OpenAI (GPT-4o mini)</option>
          <option value="anthropic" {{ "selected" if settings.llm_provider == "anthropic" }}>Anthropic (Claude 3.5 Haiku)</option>
          <option value="google" {{ "selected" if settings.llm_provider == "google" }}>Google (Gemini Flash)</option>
        </select>
      </label>
      <label>
        API Key
        <input type="password" name="llm_api_key"
          placeholder="{{ 'ì„¤ì •ë¨' if settings.llm_api_key else 'ì…ë ¥í•˜ì„¸ìš”' }}"
          autocomplete="off">
      </label>
      <p class="hint">ì„ íƒí•œ LLM providerì˜ API keyë¥¼ ì…ë ¥í•˜ì„¸ìš”. ë¹„ì›Œë‘ë©´ ê¸°ì¡´ í‚¤ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.</p>

      <h2>ğŸ¯ ì„ ë³„ ê¸°ì¤€</h2>
      <label>
        ì·¨í–¥ ë° ê´€ì‹¬ì‚¬
        <textarea name="preferences" placeholder="ì˜ˆ: í•œêµ­ ë…ë¦½ì˜í™” ìœ„ì£¼ë¡œ, ë¦¬ë·° ì„ í˜¸, ì¸í„°ë·° ì¢‹ì•„í•¨">{{ settings.preferences }}</textarea>
      </label>
      <p class="hint">AIê°€ ê¸°ì‚¬ë¥¼ ì„ ë³„í•  ë•Œ ì°¸ê³ í•  ì·¨í–¥ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”.</p>

      <div class="actions">
        <button type="submit" class="primary">ì €ì¥</button>
      </div>
    </form>

    <form method="post" action="/test-digest" style="margin-top: 1rem;">
      <button type="submit" class="secondary">ğŸ§ª í…ŒìŠ¤íŠ¸ ë‹¤ì´ì œìŠ¤íŠ¸ ì „ì†¡</button>
    </form>
  </div>

  <!-- ============================================================ -->
  <!-- Tab: Screen Alerts -->
  <!-- ============================================================ -->
  <div id="tab-screens" style="{% if active_tab != 'screens' %}display:none{% endif %}">

    {% if screen_saved %}
    <div class="alert alert-success">ìƒì˜ê´€ ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    {% endif %}
    {% if sync_triggered %}
    <div class="alert alert-info">ê·¹ì¥ ë™ê¸°í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</div>
    {% endif %}

    <form method="post" action="/screens/save">
      <h2>ğŸ”” ì•Œë¦¼ ì„¤ì •</h2>
      <label>
        <input type="checkbox" name="screen_alerts_enabled" value="true"
          {{ "checked" if screen_settings.alerts_enabled }}>
        ìƒì˜ê´€ ì•Œë¦¼ í™œì„±í™”
      </label>
      <div class="row">
        <label>
          ì²´í¬ ê°„ê²© (ë¶„)
          <input type="number" name="check_interval_minutes" min="10" max="120"
            value="{{ screen_settings.check_interval_minutes }}">
        </label>
      </div>
      <p class="hint">ê°ì‹œ ì¤‘ì¸ ìƒì˜ê´€ì˜ ìŠ¤ì¼€ì¤„ì„ í™•ì¸í•˜ëŠ” ì£¼ê¸°ì…ë‹ˆë‹¤ (10~120ë¶„).</p>

      <h2>ğŸ¥ ê°ì‹œ ìƒì˜ê´€ ì„ íƒ</h2>

      {% set chain_labels = {"cgv": "CGV", "lotte": "ë¡¯ë°ì‹œë„¤ë§ˆ", "megabox": "ë©”ê°€ë°•ìŠ¤", "cineq": "ì”¨ë„¤Q", "indie": "ë…ë¦½ì˜í™”ê´€"} %}

      {% for chain_key in ["cgv", "lotte", "megabox", "cineq", "indie"] %}
        {% set chain_theaters = chains.get(chain_key, []) %}
        {% if chain_theaters %}
        <details class="chain-group">
          <summary>{{ chain_labels[chain_key] }} ({{ chain_theaters|length }}ê°œ ê·¹ì¥)</summary>

          {% for theater in chain_theaters %}
            {% if theater.screens %}
            <details class="theater-group">
              <summary>
                {{ theater.name }}
                {% if theater.address %}
                <span class="theater-addr">{{ theater.address[:30] }}{% if theater.address|length > 30 %}...{% endif %}</span>
                {% endif %}
              </summary>
              {% for screen in theater.screens %}
              <label class="screen-label {% if screen.is_special %}special{% endif %}">
                <input type="checkbox" name="watched_screens"
                  value="{{ theater.chain }}:{{ theater.theater_code }}:{{ screen.screen_id }}"
                  {{ "checked" if screen_settings.is_watching(theater.chain ~ ':' ~ theater.theater_code ~ ':' ~ screen.screen_id) }}>
                {{ screen.name }}
                {% if screen.screen_type != "normal" %}
                  <span class="badge">{{ screen.screen_type }}</span>
                {% endif %}
                {% if screen.seat_count > 0 %}
                  <span class="seats">{{ screen.seat_count }}ì„</span>
                {% endif %}
              </label>
              {% endfor %}
            </details>
            {% else %}
            <div style="padding-left: 1rem;">
              <span class="no-data">{{ theater.name }}</span>
            </div>
            {% endif %}
          {% endfor %}

        </details>
        {% endif %}
      {% endfor %}

      {% set total_theaters = (chains.get("cgv", [])|length) + (chains.get("lotte", [])|length) + (chains.get("megabox", [])|length) + (chains.get("cineq", [])|length) + (chains.get("indie", [])|length) %}
      {% if total_theaters == 0 %}
      <p class="no-data">ê·¹ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ë™ê¸°í™”ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</p>
      {% endif %}

      <div class="actions">
        <button type="submit" class="primary">ì €ì¥</button>
      </div>
    </form>

    <form method="post" action="/screens/sync" style="margin-top: 1rem;">
      <button type="submit" class="secondary">ğŸ”„ ê·¹ì¥ ìˆ˜ë™ ë™ê¸°í™”</button>
    </form>
  </div>

  <script>
    function switchTab(tab) {
      document.getElementById('tab-digest').style.display = tab === 'digest' ? '' : 'none';
      document.getElementById('tab-screens').style.display = tab === 'screens' ? '' : 'none';
      document.querySelectorAll('.tab').forEach(function(el, i) {
        el.classList.toggle('active', (tab === 'digest' && i === 0) || (tab === 'screens' && i === 1));
      });
    }
  </script>
</body>
</html>
