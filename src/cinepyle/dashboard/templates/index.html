<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>cinePyle Dashboard</title>
  <link rel="icon" type="image/png" href="/asset/favicon.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      line-height: 1.6;
      padding: 2rem;
      max-width: 700px;
      margin: 0 auto;
    }
    .header { display: flex; align-items: center; gap: 0.7rem; margin-bottom: 1rem; }
    .header-icon { width: 32px; height: 32px; border-radius: 6px; flex-shrink: 0; }
    .header h1 { font-size: 1.5rem; color: #fff; line-height: 1; }
    .header .settings-btn {
      background: none; border: none; color: #666; cursor: pointer;
      padding: 0; margin: 0; line-height: 1; transition: color 0.2s;
      display: flex; align-items: center;
    }
    .header .settings-btn:hover { color: #fff; }
    .header-right { margin-left: auto; display: flex; align-items: center; gap: 0.6rem; }
    .gh-link {
      display: inline-flex; align-items: center; gap: 0.35rem;
      color: #888; text-decoration: none; font-size: 0.8rem; transition: color 0.2s;
    }
    .gh-link:hover { color: #fff; }
    .gh-link svg { width: 18px; height: 18px; fill: currentColor; }
    .gh-star {
      display: inline-flex; align-items: center; gap: 0.3rem;
      background: #222; border: 1px solid #444; border-radius: 5px;
      padding: 0.2rem 0.6rem; color: #ccc; text-decoration: none;
      font-size: 0.75rem; transition: all 0.2s;
    }
    .gh-star:hover { background: #333; color: #fff; border-color: #666; }
    .gh-star svg { width: 14px; height: 14px; fill: currentColor; }

    h2 {
      font-size: 1.1rem; margin: 1.5rem 0 0.75rem; color: #ccc;
      border-bottom: 1px solid #333; padding-bottom: 0.4rem;
    }
    label { display: block; margin: 0.4rem 0; cursor: pointer; }
    input[type="text"], input[type="password"], input[type="number"],
    textarea, select {
      width: 100%; padding: 0.5rem 0.7rem; background: #1a1a1a;
      border: 1px solid #333; border-radius: 6px; color: #e0e0e0; font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    input[type="number"] { width: 80px; }
    textarea { min-height: 80px; resize: vertical; }
    select { width: auto; min-width: 100px; }
    .row { display: flex; gap: 1rem; align-items: center; margin: 0.5rem 0; }
    button {
      padding: 0.6rem 1.4rem; border: none; border-radius: 6px;
      font-size: 0.9rem; cursor: pointer; margin-top: 0.5rem;
    }
    button.primary { background: #7c3aed; color: #fff; }
    button.primary:hover { background: #6d28d9; }
    button.secondary { background: #333; color: #e0e0e0; }
    button.secondary:hover { background: #444; }
    .alert { padding: 0.6rem 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
    .alert-success { background: #14532d; color: #86efac; }
    .alert-info { background: #2e1065; color: #c4b5fd; }
    .hint { font-size: 0.8rem; color: #888; margin-top: 0.2rem; }
    .actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 1.5rem; }
    .tab {
      flex: 1; padding: 0.7rem; border: 1px solid #333;
      background: #1a1a1a; color: #666; cursor: pointer;
      font-size: 0.9rem; border-radius: 0;
      transition: background 0.15s, color 0.15s;
    }
    .tab + .tab { border-left: none; }
    .tab:first-child { border-radius: 6px 0 0 6px; }
    .tab:last-child { border-radius: 0 6px 6px 0; }
    .tab:hover { color: #ccc; }
    .tab.active { background: #7c3aed; color: #fff; border-color: #7c3aed; }

    /* Env badge */
    .env-field { opacity: 0.35; pointer-events: none; }
    .env-badge {
      display: inline-block; font-size: 0.65rem; background: #2e1065; color: #c4b5fd;
      padding: 0.1rem 0.5rem; border-radius: 3px; margin-left: 0.4rem;
      vertical-align: middle;
    }

    /* Settings panel (overlay) */
    .settings-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      z-index: 100; justify-content: center; align-items: start; padding: 2rem 1rem;
      overflow-y: auto;
    }
    .settings-overlay.open { display: flex; }
    .settings-panel {
      background: #1a1a1a; border: 1px solid #333; border-radius: 10px;
      padding: 1.5rem 2rem; width: 100%; max-width: 860px;
    }
    .settings-panel h2:first-child { margin-top: 0; }
    .settings-panel .close-btn {
      float: right; background: none; border: none; color: #888;
      font-size: 1.5rem; cursor: pointer; padding: 0; margin: 0; line-height: 1;
    }
    .settings-panel .close-btn:hover { color: #fff; }
    .settings-2col {
      display: grid; grid-template-columns: 1fr 1fr; gap: 0 2rem;
    }
    .settings-2col .settings-col { min-width: 0; }
    .settings-group { margin-bottom: 1rem; }
    .settings-group-header {
      font-size: 0.9rem; font-weight: 600; color: #aaa; margin: 1rem 0 0.5rem;
      border-bottom: 1px solid #222; padding-bottom: 0.3rem;
    }

    /* LLM provider cards with drag-and-drop */
    .llm-providers { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; }
    .llm-card {
      background: #222; border: 1px solid #333; border-radius: 8px;
      padding: 0.6rem 0.8rem; cursor: grab; transition: all 0.2s;
      position: relative;
    }
    .llm-card:active { cursor: grabbing; }
    .llm-card.dragging { opacity: 0.5; border-color: #7c3aed; }
    .llm-card.drag-over { border-color: #7c3aed; border-style: dashed; }
    .llm-card-header {
      display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;
    }
    .llm-card .drag-handle {
      color: #555; font-size: 1rem; flex-shrink: 0; cursor: grab;
    }
    .llm-card .provider-name {
      font-size: 0.85rem; font-weight: 600; color: #ccc;
    }
    .llm-card .priority-badge {
      font-size: 0.6rem; background: #7c3aed33; color: #c4b5fd;
      padding: 0.05rem 0.4rem; border-radius: 3px; margin-left: auto;
    }
    .llm-card label { margin: 0.2rem 0; font-size: 0.8rem; }
    .llm-card input { font-size: 0.8rem; padding: 0.35rem 0.6rem; }
    .llm-card .hint { font-size: 0.7rem; }

    /* ===== Screen picker (3-level: region → sub-region → theater) ===== */
    .screen-picker { margin-top: 0.5rem; }

    /* Selected chips */
    .selected-chips {
      display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.75rem;
      min-height: 1.6rem;
    }
    .chip {
      display: inline-flex; align-items: center; gap: 0.3rem;
      background: #2e1065; color: #c4b5fd; border-radius: 4px;
      padding: 0.15rem 0.5rem; font-size: 0.75rem;
    }
    .chip .chain-tag {
      font-size: 0.6rem; opacity: 0.6; margin-right: 0.1rem;
    }
    .chip .x {
      cursor: pointer; font-size: 0.85rem; line-height: 1; opacity: 0.7;
      margin-left: 0.1rem;
    }
    .chip .x:hover { opacity: 1; color: #fff; }
    .no-selection { font-size: 0.8rem; color: #666; }

    /* Search */
    .screen-search {
      width: 100%; padding: 0.5rem 0.7rem; background: #111;
      border: 1px solid #333; border-radius: 6px; color: #e0e0e0;
      font-size: 0.85rem; margin-bottom: 0.75rem;
    }
    .screen-search::placeholder { color: #555; }

    /* 3-column region container */
    .region-container {
      display: flex; border: 1px solid #333; border-radius: 6px;
      overflow: hidden; height: 380px;
    }

    /* Left column: region list */
    .region-list {
      width: 70px; min-width: 70px; background: #151515; border-right: 1px solid #333;
      overflow-y: auto; flex-shrink: 0;
    }
    .region-item {
      padding: 0.5rem 0.5rem; font-size: 0.8rem; color: #888;
      cursor: pointer; border-bottom: 1px solid #1a1a1a;
      transition: all 0.15s; text-align: center;
    }
    .region-item:hover { background: #1a1a1a; color: #ccc; }
    .region-item.active { background: #222; color: #fff; border-left: 2px solid #7c3aed; }

    /* Middle column: sub-region list */
    .subregion-list {
      width: 90px; min-width: 90px; background: #181818; border-right: 1px solid #333;
      overflow-y: auto; flex-shrink: 0;
    }
    .subregion-item {
      padding: 0.4rem 0.5rem; font-size: 0.78rem; color: #888;
      cursor: pointer; border-bottom: 1px solid #1a1a1a;
      transition: all 0.15s;
    }
    .subregion-item:hover { background: #1f1f1f; color: #ccc; }
    .subregion-item.active { background: #252525; color: #fff; border-left: 2px solid #7c3aed; }
    .subregion-item .count { font-size: 0.6rem; color: #555; margin-left: 0.15rem; }
    .subregion-item.active .count { color: #888; }

    /* Right column: theater list */
    .theater-list {
      flex: 1; overflow-y: auto; padding: 0.4rem;
    }
    .theater-entry {
      padding: 0.3rem 0.5rem; border-radius: 4px;
      transition: background 0.1s;
    }
    .theater-entry:hover { background: #1a1a1a; }
    .theater-entry.hidden { display: none; }
    .theater-name-row {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 0.85rem; cursor: pointer;
    }
    .theater-name-row .chain-badge {
      font-size: 0.6rem; padding: 0.05rem 0.35rem; border-radius: 3px;
      font-weight: 600; flex-shrink: 0;
    }
    .chain-badge.cgv { background: #7b1818; color: #f99; }
    .chain-badge.lotte { background: #6b2f00; color: #fca; }
    .chain-badge.megabox { background: #1a3d6b; color: #9cf; }
    .chain-badge.cineq { background: #3d1a6b; color: #c9f; }
    .chain-badge.indie { background: #1a4a1a; color: #9f9; }
    .theater-name-text { flex: 1; color: #ccc; }
    .theater-name-row .expand-arrow {
      font-size: 0.65rem; color: #555; transition: transform 0.2s;
    }
    .theater-name-row .expand-arrow.open { transform: rotate(90deg); }

    /* Screens inside theater */
    .theater-screens {
      display: none; padding: 0.2rem 0 0.2rem 1.4rem;
    }
    .theater-screens.open { display: block; }
    .screen-item {
      display: flex; align-items: center; gap: 0.3rem;
      font-size: 0.8rem; padding: 0.1rem 0; color: #aaa;
    }
    .screen-item.special { color: #c4b5fd; }
    .screen-item input[type="checkbox"] { margin: 0; }
    .screen-badge {
      font-size: 0.6rem; background: #7c3aed33; color: #c4b5fd;
      padding: 0.02rem 0.35rem; border-radius: 3px; text-transform: uppercase;
    }
    .screen-seats { font-size: 0.65rem; color: #555; }
    .no-screens { font-size: 0.75rem; color: #555; padding: 0.2rem 0; font-style: italic; }

    /* Sync info */
    .sync-info {
      background: #1a1a1a; border: 1px solid #333; border-radius: 6px;
      padding: 0.8rem 1rem; margin: 0.75rem 0;
    }
    .sync-info .label { font-size: 0.8rem; color: #888; }
    .sync-info .value { font-size: 0.95rem; color: #e0e0e0; margin-top: 0.1rem; }
    .sync-stats { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .sync-stats .stat { text-align: center; }
    .sync-stats .stat .num { font-size: 1.3rem; font-weight: 600; color: #fff; }
    .sync-stats .stat .lbl { font-size: 0.75rem; color: #888; }

    .no-data { font-size: 0.85rem; color: #666; padding: 1rem 0; }

    /* Search highlight */
    .search-match { background: #7c3aed44; border-radius: 2px; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <img src="/asset/icon.png" alt="cinePyle" class="header-icon">
    <h1>cinePyle Dashboard</h1>
    <button type="button" class="settings-btn" onclick="toggleSettings()" title="Settings"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.611 3.611 0 0112 15.6z"/></svg></button>
    <div class="header-right">
      <a href="https://github.com/stephen-kim/cinepyle" target="_blank" rel="noopener" class="gh-link" title="GitHub">
        <svg viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      </a>
      <a href="https://github.com/stephen-kim/cinepyle/stargazers" target="_blank" rel="noopener" class="gh-star" title="Star on GitHub" id="gh-star-btn"
        onclick="event.preventDefault(); window.open('https://github.com/login?return_to=%2Fstephen-kim%2Fcinepyle', '_blank');">
        <svg viewBox="0 0 16 16"><path d="M8 .25a.75.75 0 01.673.418l1.882 3.815 4.21.612a.75.75 0 01.416 1.279l-3.046 2.97.719 4.192a.75.75 0 01-1.088.791L8 12.347l-3.766 1.98a.75.75 0 01-1.088-.79l.72-4.194L.818 6.374a.75.75 0 01.416-1.28l4.21-.611L7.327.668A.75.75 0 018 .25z"/></svg>
        Star
      </a>
    </div>
  </div>

  <!-- ============================================================ -->
  <!-- Settings Overlay -->
  <!-- ============================================================ -->
  <div class="settings-overlay" id="settings-overlay" onclick="if(event.target===this)toggleSettings()">
    <div class="settings-panel">
      <button type="button" class="close-btn" onclick="toggleSettings()">&times;</button>

      <h2>Settings</h2>

      {% macro credential_field(label, name, env_key, type="password", placeholder="") %}
      <label>
        {{ label }}
        {% if env_vars.get(env_key) %}
          <span class="env-badge">환경변수를 통해 설정됨</span>
        {% endif %}
        <input type="{{ type }}" name="{{ name }}"
          class="{% if env_vars.get(env_key) %}env-field{% endif %}"
          placeholder="{% if env_vars.get(env_key) %}환경변수를 통해 설정됨{% else %}{{ placeholder or '입력하세요' }}{% endif %}"
          autocomplete="off"
          {% if env_vars.get(env_key) %}disabled{% endif %}>
      </label>
      {% endmacro %}

      <form method="post" action="/settings/credentials">

        <div class="settings-2col">
          <!-- Left column: LLM -->
          <div class="settings-col">
            <div class="settings-group-header">LLM 프로바이더 (드래그로 우선순위 변경)</div>
            {% if env_vars.get("LLM_PROVIDER") %}
              <p style="font-size:0.8rem; margin-bottom:0.5rem;">
                <span class="env-badge">환경변수를 통해 설정됨</span>
              </p>
            {% endif %}

            <div class="llm-providers" id="llm-providers">
              {% set provider_order = settings.llm_provider_order or ["openai", "anthropic", "google"] %}
              {% set provider_labels = {"openai": "OpenAI", "anthropic": "Anthropic", "google": "Google"} %}
              {% set provider_models = {
                "openai": "gpt-4o-mini, gpt-4o, gpt-4.5-preview",
                "anthropic": "claude-3-5-haiku-latest, claude-sonnet-4-20250514",
                "google": "gemini-2.0-flash"
              } %}
              {% set provider_env_keys = {
                "openai": "OPENAI_API_KEY",
                "anthropic": "ANTHROPIC_API_KEY",
                "google": "GEMINI_API_KEY"
              } %}
              {% for provider in provider_order %}
              {% set env_key = provider_env_keys.get(provider, "") %}
              <div class="llm-card" draggable="true" data-provider="{{ provider }}"
                ondragstart="dragStart(event)" ondragover="dragOver(event)"
                ondrop="dropCard(event)" ondragend="dragEnd(event)"
                ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                <div class="llm-card-header">
                  <span class="drag-handle">&#9776;</span>
                  <span class="provider-name">{{ provider_labels.get(provider, provider) }}</span>
                  <span class="priority-badge">{{ loop.index }}순위</span>
                </div>
                <input type="hidden" name="llm_provider_order" value="{{ provider }}">
                <label>
                  API Key
                  {% if env_vars.get(env_key) %}
                    <span class="env-badge">환경변수를 통해 설정됨</span>
                  {% endif %}
                  <input type="password" name="llm_api_key_{{ provider }}"
                    class="{% if env_vars.get(env_key) %}env-field{% endif %}"
                    placeholder="{% if env_vars.get(env_key) %}환경변수를 통해 설정됨{% elif settings.llm_api_keys.get(provider) or (settings.llm_api_key and settings.llm_provider == provider) %}설정됨{% else %}입력하세요{% endif %}"
                    autocomplete="off"
                    {% if env_vars.get(env_key) %}disabled{% endif %}>
                </label>
                <label>
                  Model
                  <input type="text" name="llm_model_{{ provider }}"
                    value="{{ settings.llm_models.get(provider, '') }}"
                    placeholder="기본값: {{ provider_models.get(provider, '') }}">
                </label>
              </div>
              {% endfor %}
            </div>
            <p class="hint" style="margin-top:0.4rem;">위에서부터 높은 우선순위. 키가 있는 첫 번째 프로바이더가 사용됩니다.</p>
          </div>

          <!-- Right column: Credentials -->
          <div class="settings-col">
            <div class="settings-group-header">Telegram</div>
            {{ credential_field("Bot Token", "telegram_bot_token", "TELEGRAM_BOT_TOKEN") }}
            {{ credential_field("Chat ID", "telegram_chat_id", "TELEGRAM_CHAT_ID", type="text") }}

            <div class="settings-group-header">KOFIC (영진위)</div>
            {{ credential_field("API Key", "kofic_api_key", "KOFIC_API_KEY") }}

            <div class="settings-group-header">Naver Maps</div>
            {{ credential_field("Client ID", "naver_maps_client_id", "NAVER_MAPS_CLIENT_ID", type="text") }}
            {{ credential_field("Client Secret", "naver_maps_client_secret", "NAVER_MAPS_CLIENT_SECRET") }}

            <div class="settings-group-header">Watcha</div>
            {{ credential_field("Email", "watcha_email", "WATCHA_EMAIL", type="text") }}
            {{ credential_field("Password", "watcha_password", "WATCHA_PASSWORD") }}

            <div class="settings-group-header">CGV</div>
            {{ credential_field("ID", "cgv_id", "CGV_ID", type="text") }}
            {{ credential_field("Password", "cgv_password", "CGV_PASSWORD") }}

            <div class="settings-group-header">Lotte Cinema</div>
            {{ credential_field("ID", "lottecinema_id", "LOTTECINEMA_ID", type="text") }}
            {{ credential_field("Password", "lottecinema_password", "LOTTECINEMA_PASSWORD") }}

            <div class="settings-group-header">MegaBox</div>
            {{ credential_field("ID", "megabox_id", "MEGABOX_ID", type="text") }}
            {{ credential_field("Password", "megabox_password", "MEGABOX_PASSWORD") }}
          </div>
        </div>

        <div class="actions" style="margin-top: 1rem;">
          <button type="submit" class="primary">저장</button>
          <button type="button" class="secondary" onclick="toggleSettings()">닫기</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tab Navigation -->
  <nav class="tabs">
    <button type="button" class="tab {% if active_tab == 'digest' %}active{% endif %}"
      onclick="switchTab('digest')">다이제스트</button>
    <button type="button" class="tab {% if active_tab == 'screens' %}active{% endif %}"
      onclick="switchTab('screens')">상영관 알림</button>
  </nav>

  <!-- ============================================================ -->
  <!-- Tab: Digest -->
  <!-- ============================================================ -->
  <div id="tab-digest" style="{% if active_tab != 'digest' %}display:none{% endif %}">

    {% if saved %}
    <div class="alert alert-success">설정이 저장되었습니다.</div>
    {% endif %}
    {% if test_sent %}
    <div class="alert alert-info">테스트 다이제스트를 전송합니다. 텔레그램을 확인하세요.</div>
    {% endif %}

    <form method="post" action="/settings">
      <h2>뉴스 소스</h2>
      <label>
        <input type="checkbox" name="google_enabled" value="true"
          {{ "checked" if settings.sources_enabled.get("google", True) }}>
        Google 영화뉴스
      </label>
      <label>
        <input type="checkbox" name="cine21_enabled" value="true"
          {{ "checked" if settings.sources_enabled.get("cine21", True) }}>
        Cine21
      </label>
      <label>
        <input type="checkbox" name="watcha_enabled" value="true"
          {{ "checked" if settings.sources_enabled.get("watcha", True) }}>
        Watcha 매거진
      </label>

      <h2>스케줄</h2>
      <label>
        <input type="checkbox" name="schedule_enabled" value="true"
          {{ "checked" if settings.schedule_enabled }}>
        다이제스트 활성화
      </label>
      <div class="row">
        <label>
          시간 (KST)
          <input type="number" name="schedule_hour" min="0" max="23"
            value="{{ settings.schedule_hour }}">
        </label>
        <label>
          분
          <input type="number" name="schedule_minute" min="0" max="59"
            value="{{ settings.schedule_minute }}">
        </label>
      </div>

      <h2>선별 기준</h2>
      <label>
        취향 및 관심사
        <textarea name="preferences" placeholder="예: 한국 독립영화 위주로, 리뷰 선호, 인터뷰 좋아함">{{ settings.preferences }}</textarea>
      </label>
      <p class="hint">AI가 기사를 선별할 때 참고할 취향을 자유롭게 적어주세요.</p>

      <!-- hidden fields to preserve LLM settings when saving digest form -->
      <input type="hidden" name="llm_provider" value="{{ settings.llm_provider }}">
      <input type="hidden" name="llm_api_key" value="">

      <div class="actions">
        <button type="submit" class="primary">저장</button>
      </div>
    </form>

    <form method="post" action="/test-digest" style="margin-top: 1rem;">
      <button type="submit" class="secondary">테스트 다이제스트 전송</button>
    </form>
  </div>

  <!-- ============================================================ -->
  <!-- Tab: Screen Alerts -->
  <!-- ============================================================ -->
  <div id="tab-screens" style="{% if active_tab != 'screens' %}display:none{% endif %}">

    {% if screen_saved %}
    <div class="alert alert-success">상영관 알림 설정이 저장되었습니다.</div>
    {% endif %}

    <form method="post" action="/screens/save" id="screen-form">
      <h2>알림 설정</h2>
      <label>
        <input type="checkbox" name="screen_alerts_enabled" value="true"
          {{ "checked" if screen_settings.alerts_enabled }}>
        상영관 알림 활성화
      </label>
      <div class="row">
        <label>
          체크 간격 (분)
          <input type="number" name="check_interval_minutes" min="10" max="120"
            value="{{ screen_settings.check_interval_minutes }}">
        </label>
      </div>
      <p class="hint">감시 중인 상영관의 스케줄을 확인하는 주기입니다 (10~120분).</p>

      <h2>감시 상영관 선택</h2>

      <div class="screen-picker">
        <!-- Selected chips -->
        <div class="selected-chips" id="selected-chips">
          <span class="no-selection" id="no-selection-msg">선택된 상영관이 없습니다</span>
        </div>

        <!-- Search -->
        <input type="text" class="screen-search" id="screen-search"
          placeholder="극장 또는 상영관 검색..." oninput="filterTheaters(this.value)">

        <!-- 3-level region picker: region → sub-region → theaters -->
        {% if regions %}
        <div class="region-container">
          <!-- Left: region list -->
          <div class="region-list" id="region-list">
            {% for region_name in regions.keys() %}
            <div class="region-item {% if loop.first %}active{% endif %}"
              data-region="{{ region_name }}"
              onclick="selectRegion(this, '{{ region_name }}')">
              {{ region_name }}
            </div>
            {% endfor %}
          </div>

          <!-- Middle: sub-region list -->
          <div class="subregion-list" id="subregion-list">
            {% set first_region = regions.keys()|list|first %}
            {% for region_name, sub_regions in regions.items() %}
              {% for sub_name, theaters in sub_regions.items() %}
              <div class="subregion-item {% if region_name == first_region and loop.first %}active{% endif %}"
                data-region="{{ region_name }}"
                data-subregion="{{ sub_name }}"
                onclick="selectSubRegion(this, '{{ region_name }}', '{{ sub_name }}')"
                style="{% if region_name != first_region %}display:none{% endif %}">
                {{ sub_name }}<span class="count">{{ theaters|length }}</span>
              </div>
              {% endfor %}
            {% endfor %}
          </div>

          <!-- Right: theater list -->
          <div class="theater-list" id="theater-list">
            {% set first_region = regions.keys()|list|first %}
            {% set first_sub = regions[first_region].keys()|list|first if first_region else '' %}
            {% for region_name, sub_regions in regions.items() %}
              {% for sub_name, theaters in sub_regions.items() %}
                {% for theater in theaters %}
                <div class="theater-entry"
                  data-region="{{ region_name }}"
                  data-subregion="{{ sub_name }}"
                  data-name="{{ theater.name|lower }}"
                  data-chain="{{ theater.chain }}"
                  style="{% if region_name != first_region or sub_name != first_sub %}display:none{% endif %}">
                  <div class="theater-name-row" onclick="toggleTheaterScreens(this)">
                    <span class="chain-badge {{ theater.chain }}">{{ theater.chain|upper }}</span>
                    <span class="theater-name-text">{{ theater.name }}</span>
                    {% if theater.screens %}
                    <span class="expand-arrow">&#9654;</span>
                    {% endif %}
                  </div>
                  {% if theater.screens %}
                  <div class="theater-screens">
                    {% for screen in theater.screens %}
                    <label class="screen-item {% if screen.is_special %}special{% endif %}"
                      data-screen-name="{{ screen.name|lower }}">
                      <input type="checkbox" name="watched_screens"
                        value="{{ theater.chain }}:{{ theater.theater_code }}:{{ screen.screen_id }}"
                        data-theater-name="{{ theater.name }}"
                        data-screen-name="{{ screen.name }}"
                        data-chain="{{ theater.chain }}"
                        {{ "checked" if screen_settings.is_watching(theater.chain ~ ':' ~ theater.theater_code ~ ':' ~ screen.screen_id) }}
                        onchange="updateChips()">
                      <span>{{ screen.name }}</span>
                      {% if screen.screen_type != "normal" %}
                        <span class="screen-badge">{{ screen.screen_type }}</span>
                      {% endif %}
                      {% if screen.seat_count > 0 %}
                        <span class="screen-seats">{{ screen.seat_count }}석</span>
                      {% endif %}
                    </label>
                    {% endfor %}
                  </div>
                  {% else %}
                  <div class="theater-screens">
                    <div class="no-screens">상영관 정보 없음 (동기화 필요)</div>
                  </div>
                  {% endif %}
                </div>
                {% endfor %}
              {% endfor %}
            {% endfor %}
          </div>
        </div>
        {% else %}
        <p class="no-data">극장 데이터가 없습니다. 다음 자동 갱신을 기다려주세요.</p>
        {% endif %}
      </div>

      <div class="actions">
        <button type="submit" class="primary">저장</button>
      </div>
    </form>
  </div>

  <script>
    // ==================== Tab switching ====================
    var TABS = ['digest', 'screens'];

    function switchTab(tab, pushState) {
      if (pushState !== false) {
        history.replaceState(null, '', '?tab=' + tab);
      }
      TABS.forEach(function(t) {
        document.getElementById('tab-' + t).style.display = t === tab ? '' : 'none';
      });
      document.querySelectorAll('.tab').forEach(function(el, i) {
        el.classList.toggle('active', TABS[i] === tab);
      });
    }

    // ==================== Settings overlay ====================
    function toggleSettings() {
      document.getElementById('settings-overlay').classList.toggle('open');
    }

    // ==================== 3-level region navigation ====================
    var currentRegion = '';
    var currentSubRegion = '';

    function selectRegion(el, region) {
      // Update region active state
      document.querySelectorAll('.region-item').forEach(function(r) {
        r.classList.remove('active');
      });
      el.classList.add('active');
      currentRegion = region;

      // Show sub-regions for this region, hide others
      var firstSub = null;
      document.querySelectorAll('.subregion-item').forEach(function(s) {
        if (s.dataset.region === region) {
          s.style.display = '';
          if (!firstSub) firstSub = s;
        } else {
          s.style.display = 'none';
          s.classList.remove('active');
        }
      });

      // Auto-select first sub-region
      if (firstSub) {
        document.querySelectorAll('.subregion-item').forEach(function(s) {
          s.classList.remove('active');
        });
        firstSub.classList.add('active');
        currentSubRegion = firstSub.dataset.subregion;
        showTheatersForSubRegion(region, currentSubRegion);
      }
    }

    function selectSubRegion(el, region, subRegion) {
      // Update sub-region active state
      document.querySelectorAll('.subregion-item').forEach(function(s) {
        s.classList.remove('active');
      });
      el.classList.add('active');
      currentSubRegion = subRegion;

      showTheatersForSubRegion(region, subRegion);
    }

    function showTheatersForSubRegion(region, subRegion) {
      document.querySelectorAll('.theater-entry').forEach(function(entry) {
        var match = entry.dataset.region === region && entry.dataset.subregion === subRegion;
        entry.style.display = match ? '' : 'none';
        // Collapse screens when switching
        var screens = entry.querySelector('.theater-screens');
        var arrow = entry.querySelector('.expand-arrow');
        if (screens) screens.classList.remove('open');
        if (arrow) arrow.classList.remove('open');
      });
    }

    // ==================== Search ====================
    function filterTheaters(query) {
      var q = query.toLowerCase().trim();

      if (q) {
        // Search across ALL regions — show all matching theaters
        // Hide sub-region column during search
        document.querySelectorAll('.theater-entry').forEach(function(entry) {
          var name = entry.dataset.name || '';
          var screenNames = [];
          entry.querySelectorAll('.screen-item').forEach(function(s) {
            screenNames.push((s.dataset.screenName || '').toLowerCase());
          });
          var allText = name + ' ' + screenNames.join(' ');
          var match = allText.indexOf(q) !== -1;
          entry.style.display = match ? '' : 'none';
          if (match) {
            // Auto-expand screens when searching
            var screens = entry.querySelector('.theater-screens');
            var arrow = entry.querySelector('.expand-arrow');
            if (screens) screens.classList.add('open');
            if (arrow) arrow.classList.add('open');
          }
        });
      } else {
        // No search — restore current region/sub-region view
        var region = currentRegion || document.querySelector('.region-item.active')?.dataset.region || '';
        var subRegion = currentSubRegion || document.querySelector('.subregion-item.active')?.dataset.subregion || '';
        document.querySelectorAll('.theater-entry').forEach(function(entry) {
          var match = entry.dataset.region === region && entry.dataset.subregion === subRegion;
          entry.style.display = match ? '' : 'none';
          // Collapse screens
          var screens = entry.querySelector('.theater-screens');
          var arrow = entry.querySelector('.expand-arrow');
          if (screens) screens.classList.remove('open');
          if (arrow) arrow.classList.remove('open');
        });
      }
    }

    // ==================== Theater expand/collapse ====================
    function toggleTheaterScreens(row) {
      var entry = row.closest('.theater-entry');
      var screens = entry.querySelector('.theater-screens');
      var arrow = row.querySelector('.expand-arrow');
      if (screens) {
        screens.classList.toggle('open');
        if (arrow) arrow.classList.toggle('open');
      }
    }

    // ==================== Chip management ====================
    function updateChips() {
      var chipsContainer = document.getElementById('selected-chips');
      var noMsg = document.getElementById('no-selection-msg');
      var checked = document.querySelectorAll('#screen-form input[name="watched_screens"]:checked');

      // Clear existing chips
      chipsContainer.querySelectorAll('.chip').forEach(function(c) { c.remove(); });

      if (checked.length === 0) {
        noMsg.style.display = '';
        return;
      }
      noMsg.style.display = 'none';

      checked.forEach(function(cb) {
        var chip = document.createElement('span');
        chip.className = 'chip';
        var chain = cb.dataset.chain.toUpperCase();
        var theater = cb.dataset.theaterName;
        var screen = cb.dataset.screenName;
        chip.innerHTML = '<span class="chain-tag">' + chain + '</span>' +
          theater + ' ' + screen +
          '<span class="x" onclick="removeChip(this, \'' + cb.value.replace(/'/g, "\\'") + '\')">&times;</span>';
        chipsContainer.appendChild(chip);
      });
    }

    function removeChip(xEl, value) {
      var cb = document.querySelector('#screen-form input[value="' + value + '"]');
      if (cb) {
        cb.checked = false;
      }
      xEl.parentElement.remove();
      // Check if any left
      var remaining = document.querySelectorAll('#selected-chips .chip');
      if (remaining.length === 0) {
        document.getElementById('no-selection-msg').style.display = '';
      }
    }

    // ==================== LLM card drag-and-drop ====================
    var draggedCard = null;

    function dragStart(e) {
      draggedCard = e.currentTarget;
      draggedCard.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function dragEnd(e) {
      if (draggedCard) draggedCard.classList.remove('dragging');
      document.querySelectorAll('.llm-card').forEach(function(c) {
        c.classList.remove('drag-over');
      });
      draggedCard = null;
      updatePriorityBadges();
    }

    function dragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function dragEnter(e) {
      e.preventDefault();
      var card = e.currentTarget;
      if (card !== draggedCard) card.classList.add('drag-over');
    }

    function dragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function dropCard(e) {
      e.preventDefault();
      var target = e.currentTarget;
      target.classList.remove('drag-over');
      if (!draggedCard || target === draggedCard) return;

      var container = document.getElementById('llm-providers');
      var cards = Array.from(container.querySelectorAll('.llm-card'));
      var dragIdx = cards.indexOf(draggedCard);
      var targetIdx = cards.indexOf(target);

      if (dragIdx < targetIdx) {
        container.insertBefore(draggedCard, target.nextSibling);
      } else {
        container.insertBefore(draggedCard, target);
      }
      updatePriorityBadges();
    }

    function updatePriorityBadges() {
      var cards = document.querySelectorAll('#llm-providers .llm-card');
      cards.forEach(function(card, i) {
        var badge = card.querySelector('.priority-badge');
        if (badge) badge.textContent = (i + 1) + '순위';
      });
    }

    // ==================== Init ====================
    (function() {
      // Restore tab from URL query parameter
      var params = new URLSearchParams(window.location.search);
      var tabParam = params.get('tab');
      if (tabParam && TABS.indexOf(tabParam) !== -1) {
        switchTab(tabParam, false);
      }

      // Set initial region & sub-region
      var firstRegion = document.querySelector('.region-item.active');
      if (firstRegion) {
        currentRegion = firstRegion.dataset.region;
      }
      var firstSub = document.querySelector('.subregion-item.active');
      if (firstSub) {
        currentSubRegion = firstSub.dataset.subregion;
      }
      // Build initial chips
      updateChips();
    })();
  </script>
</body>
</html>
